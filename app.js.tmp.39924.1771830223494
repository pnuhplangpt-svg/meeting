
import {
  initNetworkBanner, registerServiceWorker, navigateTo, initInstallBanner,
  showToast, showLoading, openModal, closeModal, resetAndGoHome,
  handleInstallClick, dismissInstallBanner, initModalListeners
} from './js/ui/common.js';
import { initDisplayMode, toggleDisplayFullscreen, loadDisplayData } from './js/ui/display.js';
import { setTodayDate } from './js/utils.js';
import { loadRoomsForHome, selectFloor } from './js/ui/home.js';
import {
  changeMonth, selectDate, selectTime, requestEdit, requestDelete, switchTab,
  startReservation, handleConfirmReservation, loadReservations,
  confirmPasswordModal, confirmDeleteModal
} from './js/ui/reservation.js';
import {
  openAdminAuth, exitAdminMode, adminRefresh, adminDeletePast, adminAddRoom,
  verifyAdminCode, switchAdminTab, adminFilter, adminDeleteOne,
  adminToggleRoom, adminRemoveRoom, adminEditRoom, adminLoadMetrics,
  adminRunChecks, adminSendMetricsReport
} from './js/ui/admin.js';

// ═══════════════════════════════════════════════════════
// 초기화
// ═══════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', function () {
  // 디스플레이 모드 감지 (?display=6F 등)
  if (initDisplayMode()) {
    // 디스플레이 모드: 일반 UI 초기화 건너뜀
    initNetworkBanner();
    registerServiceWorker();
    bindDisplayActions(); // 디스플레이 모드용 이벤트 바인딩
    return;
  }

  // 일반 모드
  bindUiActions();
  setTodayDate();
  initNetworkBanner();
  navigateTo('screenHome');
  initInstallBanner();

  registerServiceWorker();
});


function bindDisplayActions() {
  var byId = function (id) { return document.getElementById(id); };

  var btnDisplayRefresh = byId('btnDisplayRefresh');
  if (btnDisplayRefresh) btnDisplayRefresh.addEventListener('click', loadDisplayData);

  var btnFullscreen = byId('btnFullscreen');
  if (btnFullscreen) btnFullscreen.addEventListener('click', toggleDisplayFullscreen);
}


function bindUiActions() {
  var byId = function (id) { return document.getElementById(id); };

  // Common buttons
  var btnDismissInstallBanner = byId('btnDismissInstallBanner');
  if (btnDismissInstallBanner) btnDismissInstallBanner.addEventListener('click', dismissInstallBanner);

  var installBtn = byId('installBtn');
  if (installBtn) installBtn.addEventListener('click', handleInstallClick);

  // Reservation flow
  var btnStartReserve = byId('btnStartReserve');
  if (btnStartReserve) btnStartReserve.addEventListener('click', startReservation);

  var btnConfirmReserve = byId('btnConfirmReserve');
  if (btnConfirmReserve) btnConfirmReserve.addEventListener('click', handleConfirmReservation);

  // Admin mode
  var btnOpenAdminAuth = byId('btnOpenAdminAuth');
  if (btnOpenAdminAuth) btnOpenAdminAuth.addEventListener('click', openAdminAuth);

  var btnExitAdminMode = byId('btnExitAdminMode');
  if (btnExitAdminMode) btnExitAdminMode.addEventListener('click', exitAdminMode);

  var btnAdminRefresh = byId('btnAdminRefresh');
  if (btnAdminRefresh) btnAdminRefresh.addEventListener('click', adminRefresh);

  var btnAdminDeletePast = byId('btnAdminDeletePast');
  if (btnAdminDeletePast) btnAdminDeletePast.addEventListener('click', adminDeletePast);

  var btnAdminAddRoom = byId('btnAdminAddRoom');
  if (btnAdminAddRoom) btnAdminAddRoom.addEventListener('click', adminAddRoom);

  var btnVerifyAdminCode = byId('btnVerifyAdminCode');
  if (btnVerifyAdminCode) btnVerifyAdminCode.addEventListener('click', verifyAdminCode);

  var btnAdminMetrics = byId('btnAdminMetrics');
  if (btnAdminMetrics) btnAdminMetrics.addEventListener('click', adminLoadMetrics);

  var btnAdminChecks = byId('btnAdminChecks');
  if (btnAdminChecks) btnAdminChecks.addEventListener('click', adminRunChecks);

  var btnAdminSendReport = byId('btnAdminSendReport');
  if (btnAdminSendReport) btnAdminSendReport.addEventListener('click', adminSendMetricsReport);


  // Global listener
  initModalListeners();
  document.addEventListener('click', function (e) {
    var el = e.target.closest('[data-action]');
    if (!el) return;

    var action = el.dataset.action;
    if (action === 'go-my-reservations') return navigateTo('screenMyReservations');
    if (action === 'go-home') return navigateTo('screenHome');
    if (action === 'reset-home') return resetAndGoHome();
    if (action === 'close-modal') return closeModal(el.dataset.modalId);
    if (action === 'switch-tab') return switchTab(el);
    if (action === 'switch-admin-tab') return switchAdminTab(el);
    if (action === 'admin-filter') return adminFilter(el);
    if (action === 'select-floor') return selectFloor(el);
    if (action === 'calendar-prev') return changeMonth(-1);
    if (action === 'calendar-next') return changeMonth(1);
    if (action === 'select-date') return selectDate(el.dataset.date);
    if (action === 'select-time') return selectTime(el.dataset.time);
    if (action === 'request-edit') return requestEdit(el.dataset.id);
    if (action === 'request-delete') return requestDelete(el.dataset.id);
    if (action === 'admin-delete-one') return adminDeleteOne(el.dataset.id);
    if (action === 'admin-toggle-room') return adminToggleRoom(el.dataset.roomId, el.dataset.active === 'true');
    if (action === 'admin-edit-room') return adminEditRoom(el.dataset.roomId);
    if (action === 'admin-remove-room') return adminRemoveRoom(el.dataset.roomId);
  });
}