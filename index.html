<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#006241">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>J동 회의실 예약</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23006241' width='100' height='100' rx='20'/><text x='50' y='62' text-anchor='middle' fill='white' font-size='40' font-family='sans-serif' font-weight='bold'>J</text></svg>">
  <style>
    /* ─── Reset & Base ─────────────────────────────── */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --green: #006241;
      --green-light: #00754a;
      --green-pale: #d4e9e2;
      --green-bg: #eaf5f0;
      --white: #ffffff;
      --gray-bg: #f6f6f6;
      --gray-light: #e8e8e8;
      --gray-mid: #c0c0c0;
      --gray-text: #6b6b6b;
      --dark: #1e3932;
      --black: #000000;
      --red: #d62b1e;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
      --shadow-md: 0 2px 8px rgba(0,0,0,0.06);
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-full: 50px;
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white);
      color: var(--black);
      line-height: 1.5;
      overflow-x: hidden;
      min-height: 100vh;
      min-height: 100dvh;
    }

    /* ─── App Container ────────────────────────────── */
    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      min-height: 100dvh;
      position: relative;
      background: var(--white);
    }

    /* ─── Screens ──────────────────────────────────── */
    .screen {
      display: none;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.35s ease, transform 0.35s ease;
      padding-bottom: 120px;
    }

    .screen.active {
      display: block;
    }

    .screen.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* ─── Header ───────────────────────────────────── */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--white);
      padding: 16px 24px;
      border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    .header-back {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      font-size: 15px;
      color: var(--green);
      cursor: pointer;
      padding: 8px 0;
      margin-bottom: 4px;
      font-weight: 500;
      transition: var(--transition);
    }

    .header-back:active {
      opacity: 0.6;
    }

    .header-back svg {
      width: 20px;
      height: 20px;
    }

    .header h1 {
      font-size: 26px;
      font-weight: 700;
      color: var(--dark);
      letter-spacing: -0.5px;
    }

    .header .subtitle {
      font-size: 14px;
      color: var(--gray-text);
      margin-top: 2px;
      font-weight: 400;
    }

    /* ─── Section ──────────────────────────────────── */
    .section {
      padding: 20px 24px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 14px;
      letter-spacing: -0.3px;
    }

    .section-desc {
      font-size: 13px;
      color: var(--gray-text);
      margin-top: -8px;
      margin-bottom: 14px;
    }

    /* ─── Floor Cards ──────────────────────────────── */
    .floor-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .floor-card {
      background: var(--gray-bg);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      padding: 24px 16px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .floor-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--green);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: var(--radius-md);
    }

    .floor-card:active {
      transform: scale(0.96);
    }

    .floor-card.selected {
      border-color: var(--green);
      background: var(--green-bg);
    }

    .floor-card.selected::before {
      opacity: 0.05;
    }

    .floor-card .floor-number {
      font-size: 32px;
      font-weight: 800;
      color: var(--dark);
      position: relative;
      z-index: 1;
      transition: var(--transition);
    }

    .floor-card.selected .floor-number {
      color: var(--green);
    }

    .floor-card .floor-label {
      font-size: 13px;
      color: var(--gray-text);
      margin-top: 4px;
      position: relative;
      z-index: 1;
      transition: var(--transition);
    }

    .floor-card.selected .floor-label {
      color: var(--green);
      font-weight: 600;
    }

    /* ─── Calendar ─────────────────────────────────── */
    .calendar-container {
      background: var(--white);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0 16px;
    }

    .calendar-nav button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--gray-bg);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .calendar-nav button:active {
      transform: scale(0.9);
      background: var(--gray-light);
    }

    .calendar-nav button svg {
      width: 18px;
      height: 18px;
      color: var(--dark);
    }

    .calendar-month {
      font-size: 17px;
      font-weight: 700;
      color: var(--dark);
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 8px;
    }

    .calendar-weekdays span {
      font-size: 12px;
      color: var(--gray-mid);
      font-weight: 600;
      padding: 8px 0;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      background: none;
      color: var(--black);
    }

    .calendar-day:active {
      transform: scale(0.85);
    }

    .calendar-day.today {
      background: var(--green-pale);
      color: var(--green);
      font-weight: 700;
    }

    .calendar-day.selected {
      background: var(--green);
      color: var(--white);
      font-weight: 700;
    }

    .calendar-day.disabled {
      color: var(--gray-light);
      cursor: default;
      pointer-events: none;
    }

    .calendar-day.other-month {
      color: var(--gray-light);
    }

    /* ─── Time Slots ───────────────────────────────── */
    .time-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .time-slot {
      padding: 12px 4px;
      border-radius: var(--radius-sm);
      border: 1.5px solid var(--gray-light);
      background: var(--white);
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      color: var(--dark);
    }

    .time-slot:active {
      transform: scale(0.94);
    }

    .time-slot.selected {
      background: var(--green);
      border-color: var(--green);
      color: var(--white);
      font-weight: 600;
    }

    .time-slot.reserved {
      background: var(--gray-bg);
      border-color: var(--gray-bg);
      color: var(--gray-mid);
      cursor: not-allowed;
      pointer-events: none;
    }

    .time-slot.in-range {
      background: var(--green-bg);
      border-color: var(--green-light);
      color: var(--green);
    }

    /* ─── Form Input ───────────────────────────────── */
    .input-group {
      margin-bottom: 16px;
    }

    .input-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
    }

    .input-group input {
      width: 100%;
      padding: 14px 16px;
      border: 1.5px solid var(--gray-light);
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-family: inherit;
      transition: var(--transition);
      background: var(--white);
      color: var(--black);
      outline: none;
    }

    .input-group input::placeholder {
      color: var(--gray-mid);
    }

    .input-group input:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(0, 98, 65, 0.08);
    }

    /* ─── Buttons ──────────────────────────────────── */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      outline: none;
      -webkit-user-select: none;
      user-select: none;
    }

    .btn:active {
      transform: scale(0.96);
    }

    .btn-primary {
      background: var(--green);
      color: var(--white);
      font-size: 16px;
      padding: 16px 32px;
      border-radius: var(--radius-full);
      width: 100%;
      min-height: 52px;
    }

    .btn-primary:disabled {
      background: var(--gray-light);
      color: var(--gray-mid);
      cursor: not-allowed;
      transform: none;
    }

    .btn-outline {
      background: transparent;
      color: var(--green);
      font-size: 14px;
      padding: 10px 20px;
      border-radius: var(--radius-full);
      border: 1.5px solid var(--green);
      min-height: 40px;
    }

    .btn-outline:active {
      background: var(--green-bg);
    }

    .btn-outline-red {
      background: transparent;
      color: var(--red);
      font-size: 14px;
      padding: 10px 20px;
      border-radius: var(--radius-full);
      border: 1.5px solid var(--red);
      min-height: 40px;
    }

    .btn-outline-red:active {
      background: #fef2f2;
    }

    .btn-ghost {
      background: transparent;
      color: var(--gray-text);
      font-size: 14px;
      padding: 10px 16px;
      border-radius: var(--radius-full);
    }

    /* ─── Bottom CTA ───────────────────────────────── */
    .bottom-cta {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      padding: 16px 24px;
      padding-bottom: calc(16px + var(--safe-bottom));
      background: linear-gradient(to top, var(--white) 80%, transparent);
      z-index: 200;
    }

    /* ─── Reservation Card ─────────────────────────── */
    .reservation-card {
      background: var(--white);
      border: 1px solid var(--gray-light);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 12px;
      transition: var(--transition);
    }

    .reservation-card .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .reservation-card .card-floor {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--green-bg);
      color: var(--green);
      font-size: 14px;
      font-weight: 700;
      padding: 6px 14px;
      border-radius: var(--radius-full);
    }

    .reservation-card .card-time {
      font-size: 13px;
      color: var(--gray-text);
      font-weight: 500;
    }

    .reservation-card .card-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .reservation-card .card-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .reservation-card .card-row .label {
      color: var(--gray-text);
      min-width: 52px;
    }

    .reservation-card .card-row .value {
      color: var(--dark);
      font-weight: 600;
    }

    .reservation-card .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-bg);
    }

    /* ─── Empty State ──────────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      color: var(--gray-light);
      margin-bottom: 16px;
    }

    .empty-state p {
      color: var(--gray-text);
      font-size: 15px;
    }

    /* ─── Toast ────────────────────────────────────── */
    .toast-container {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      max-width: 440px;
      width: calc(100% - 48px);
    }

    .toast {
      background: var(--dark);
      color: var(--white);
      padding: 14px 20px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transform: translateY(-12px);
      transition: all 0.3s ease;
      margin-bottom: 8px;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.error {
      background: var(--red);
    }

    .toast.success {
      background: var(--green);
    }

    /* ─── Modal ────────────────────────────────────── */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.35);
      z-index: 500;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      padding: 32px 24px;
      padding-bottom: calc(32px + var(--safe-bottom));
      width: 100%;
      max-width: 480px;
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.show .modal {
      transform: translateY(0);
    }

    .modal-handle {
      width: 40px;
      height: 4px;
      border-radius: 2px;
      background: var(--gray-light);
      margin: 0 auto 20px;
    }

    .modal h3 {
      font-size: 18px;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 20px;
      text-align: center;
    }

    .modal .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal .btn-group .btn {
      flex: 1;
    }

    /* ─── Loading Spinner ──────────────────────────── */
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--gray-light);
      border-top-color: var(--green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.7);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ─── Time Range Hint ──────────────────────────── */
    .time-hint {
      text-align: center;
      padding: 12px;
      margin-bottom: 8px;
      background: var(--green-bg);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--green);
      font-weight: 500;
    }

    /* ─── Tab Bar (My Reservations) ────────────────── */
    .tab-bar {
      display: flex;
      border-bottom: 1px solid var(--gray-light);
      padding: 0 24px;
      background: var(--white);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .tab-item {
      flex: 1;
      padding: 14px 0;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-mid);
      border: none;
      background: none;
      cursor: pointer;
      position: relative;
      transition: var(--transition);
    }

    .tab-item.active {
      color: var(--green);
    }

    .tab-item.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--green);
      border-radius: 1px;
    }

    /* ─── Divider ──────────────────────────────────── */
    .divider {
      height: 8px;
      background: var(--gray-bg);
    }

    /* ─── Badge ────────────────────────────────────── */
    .date-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--green-bg);
      color: var(--green);
      padding: 8px 16px;
      border-radius: var(--radius-full);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    /* ─── Scrollbar ────────────────────────────────── */
    ::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    /* ─── Animation Classes ────────────────────────── */
    .fade-in {
      animation: fadeIn 0.4s ease forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .stagger > * {
      opacity: 0;
      animation: fadeIn 0.4s ease forwards;
    }

    .stagger > *:nth-child(1) { animation-delay: 0.05s; }
    .stagger > *:nth-child(2) { animation-delay: 0.1s; }
    .stagger > *:nth-child(3) { animation-delay: 0.15s; }
    .stagger > *:nth-child(4) { animation-delay: 0.2s; }
    .stagger > *:nth-child(5) { animation-delay: 0.25s; }
    .stagger > *:nth-child(6) { animation-delay: 0.3s; }

    /* ─── Selection Info ───────────────────────────── */
    .selection-summary {
      background: var(--gray-bg);
      border-radius: var(--radius-md);
      padding: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .selection-summary .sel-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .selection-summary .sel-item .sel-label {
      color: var(--gray-text);
    }

    .selection-summary .sel-item .sel-value {
      color: var(--dark);
      font-weight: 600;
    }
  </style>
</head>
<body>

<div class="app" id="app">

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <!-- ════════ 1. 메인 화면 ════════ -->
  <div class="screen active" id="screenHome">
    <div class="header">
      <h1>J동 회의실 예약</h1>
      <div class="subtitle" id="todayDate"></div>
    </div>

    <div class="section">
      <div class="section-title">층 선택</div>
      <div class="floor-grid stagger" id="floorGrid">
        <div class="floor-card" data-floor="6F" onclick="selectFloor(this)">
          <div class="floor-number">6F</div>
          <div class="floor-label">미니 회의실</div>
        </div>
        <div class="floor-card" data-floor="7F" onclick="selectFloor(this)">
          <div class="floor-number">7F</div>
          <div class="floor-label">미니 회의실</div>
        </div>
        <div class="floor-card" data-floor="8F" onclick="selectFloor(this)">
          <div class="floor-number">8F</div>
          <div class="floor-label">미니 회의실</div>
        </div>
        <div class="floor-card" data-floor="9F" onclick="selectFloor(this)">
          <div class="floor-number">9F</div>
          <div class="floor-label">미니 회의실</div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="section">
      <div class="section-title">내 예약 조회</div>
      <button class="btn btn-outline" style="width:100%" onclick="navigateTo('screenMyReservations')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        예약 내역 보기
      </button>
    </div>

    <div class="bottom-cta">
      <button class="btn btn-primary" id="btnStartReserve" disabled onclick="startReservation()">
        층을 선택해주세요
      </button>
    </div>
  </div>

  <!-- ════════ 2. 예약 화면 ════════ -->
  <div class="screen" id="screenReserve">
    <div class="header">
      <button class="header-back" onclick="navigateTo('screenHome')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        뒤로
      </button>
      <h1 id="reserveTitle">예약하기</h1>
      <div class="subtitle" id="reserveSubtitle"></div>
    </div>

    <!-- 날짜 선택 -->
    <div class="section">
      <div class="section-title">날짜 선택</div>
      <div class="calendar-container" id="calendar"></div>
    </div>

    <div class="divider"></div>

    <!-- 시간 선택 -->
    <div class="section" id="timeSection" style="display:none">
      <div class="section-title">시간 선택</div>
      <div class="section-desc">시작 시간과 종료 시간을 순서대로 선택하세요</div>
      <div class="time-hint" id="timeHint">시작 시간을 선택하세요</div>
      <div class="time-grid" id="timeGrid"></div>
    </div>

    <div class="divider" id="formDivider" style="display:none"></div>

    <!-- 예약 정보 입력 -->
    <div class="section" id="formSection" style="display:none">
      <div class="section-title">예약 정보</div>

      <div class="selection-summary" id="selectionSummary" style="margin-bottom:20px"></div>

      <div class="input-group">
        <label for="inputTeam">팀명</label>
        <input type="text" id="inputTeam" placeholder="팀명을 입력하세요" maxlength="30" autocomplete="off">
      </div>
      <div class="input-group">
        <label for="inputName">예약자명</label>
        <input type="text" id="inputName" placeholder="이름을 입력하세요" maxlength="20" autocomplete="off">
      </div>
      <div class="input-group">
        <label for="inputPassword">비밀번호 (숫자 4자리)</label>
        <input type="password" id="inputPassword" placeholder="예약 수정/삭제 시 필요합니다" maxlength="4" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
      </div>
    </div>

    <div class="bottom-cta">
      <button class="btn btn-primary" id="btnConfirmReserve" disabled onclick="submitReservation()">
        예약 완료
      </button>
    </div>
  </div>

  <!-- ════════ 3. 내 예약 조회 화면 ════════ -->
  <div class="screen" id="screenMyReservations">
    <div class="header">
      <button class="header-back" onclick="navigateTo('screenHome')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        뒤로
      </button>
      <h1>예약 내역</h1>
      <div class="subtitle">예약된 회의실 현황</div>
    </div>

    <div class="tab-bar">
      <button class="tab-item active" data-tab="all" onclick="switchTab(this)">전체</button>
      <button class="tab-item" data-tab="6F" onclick="switchTab(this)">6F</button>
      <button class="tab-item" data-tab="7F" onclick="switchTab(this)">7F</button>
      <button class="tab-item" data-tab="8F" onclick="switchTab(this)">8F</button>
      <button class="tab-item" data-tab="9F" onclick="switchTab(this)">9F</button>
    </div>

    <div class="section" id="reservationsList"></div>
  </div>

  <!-- ════════ 4. 예약 완료 화면 ════════ -->
  <div class="screen" id="screenComplete">
    <div class="header">
      <h1>예약 완료</h1>
      <div class="subtitle">회의실이 예약되었습니다</div>
    </div>

    <div class="section">
      <div style="text-align:center; margin-bottom:24px;">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      </div>

      <div class="reservation-card" id="completeCard"></div>

      <div style="display:flex; gap:10px; margin-top:8px;">
        <button class="btn btn-outline" style="flex:1" onclick="navigateTo('screenMyReservations')">예약 내역 보기</button>
        <button class="btn btn-primary" style="flex:1" onclick="resetAndGoHome()">홈으로</button>
      </div>
    </div>
  </div>

  <!-- ════════ 비밀번호 확인 모달 ════════ -->
  <div class="modal-overlay" id="modalPassword">
    <div class="modal">
      <div class="modal-handle"></div>
      <h3>비밀번호 확인</h3>
      <div class="input-group">
        <input type="password" id="modalPasswordInput" placeholder="4자리 비밀번호 입력" maxlength="4" inputmode="numeric" pattern="[0-9]*">
      </div>
      <div class="btn-group">
        <button class="btn btn-ghost" onclick="closeModal('modalPassword')">취소</button>
        <button class="btn btn-primary" style="flex:2" id="modalPasswordConfirm">확인</button>
      </div>
    </div>
  </div>

  <!-- ════════ 삭제 확인 모달 ════════ -->
  <div class="modal-overlay" id="modalDelete">
    <div class="modal">
      <div class="modal-handle"></div>
      <h3>예약을 삭제하시겠습니까?</h3>
      <p style="text-align:center; color:var(--gray-text); font-size:14px; margin-bottom:8px;">이 작업은 되돌릴 수 없습니다.</p>
      <div class="btn-group">
        <button class="btn btn-ghost" onclick="closeModal('modalDelete')">취소</button>
        <button class="btn btn-outline-red" style="flex:2" id="modalDeleteConfirm">삭제</button>
      </div>
    </div>
  </div>

</div>

<script>
// ═══════════════════════════════════════════════════════
// 설정
// ═══════════════════════════════════════════════════════
const API_URL = 'https://script.google.com/macros/s/AKfycbxcFXOn1btraUlwjNkKQq3g-r4fj6x23ezWNorvo0LFWvUL1Jxg6nuj3z-Hwn6SsOTWNw/exec';

// ═══════════════════════════════════════════════════════
// 상태 관리
// ═══════════════════════════════════════════════════════
const state = {
  selectedFloor: null,
  selectedDate: null,
  selectedStartTime: null,
  selectedEndTime: null,
  calendarYear: new Date().getFullYear(),
  calendarMonth: new Date().getMonth(),
  reservations: [],
  currentTab: 'all',
  pendingAction: null,
  pendingId: null
};

// ═══════════════════════════════════════════════════════
// 초기화
// ═══════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', function() {
  setTodayDate();
  showScreen('screenHome');

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(function() {});
  }
});

function setTodayDate() {
  const now = new Date();
  const days = ['일', '월', '화', '수', '목', '금', '토'];
  const str = now.getFullYear() + '년 ' +
    (now.getMonth() + 1) + '월 ' +
    now.getDate() + '일 ' +
    days[now.getDay()] + '요일';
  document.getElementById('todayDate').textContent = str;
}

// ═══════════════════════════════════════════════════════
// 화면 전환
// ═══════════════════════════════════════════════════════
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(function(s) {
    s.classList.remove('active', 'visible');
  });
  const target = document.getElementById(id);
  target.classList.add('active');
  requestAnimationFrame(function() {
    requestAnimationFrame(function() {
      target.classList.add('visible');
    });
  });
  window.scrollTo(0, 0);
}

function navigateTo(screenId) {
  if (screenId === 'screenMyReservations') {
    loadReservations();
  }
  showScreen(screenId);
}

function resetAndGoHome() {
  state.selectedFloor = null;
  state.selectedDate = null;
  state.selectedStartTime = null;
  state.selectedEndTime = null;

  document.querySelectorAll('.floor-card').forEach(function(c) {
    c.classList.remove('selected');
  });

  const btn = document.getElementById('btnStartReserve');
  btn.disabled = true;
  btn.textContent = '층을 선택해주세요';

  showScreen('screenHome');
}

// ═══════════════════════════════════════════════════════
// 층 선택
// ═══════════════════════════════════════════════════════
function selectFloor(el) {
  document.querySelectorAll('.floor-card').forEach(function(c) {
    c.classList.remove('selected');
  });
  el.classList.add('selected');
  state.selectedFloor = el.dataset.floor;

  const btn = document.getElementById('btnStartReserve');
  btn.disabled = false;
  btn.textContent = state.selectedFloor + ' 회의실 예약하기';
}

// ═══════════════════════════════════════════════════════
// 예약 시작
// ═══════════════════════════════════════════════════════
function startReservation() {
  if (!state.selectedFloor) return;

  state.selectedDate = null;
  state.selectedStartTime = null;
  state.selectedEndTime = null;
  state.calendarYear = new Date().getFullYear();
  state.calendarMonth = new Date().getMonth();

  document.getElementById('reserveTitle').textContent = state.selectedFloor + ' 예약하기';
  document.getElementById('reserveSubtitle').textContent = 'J동 ' + state.selectedFloor + ' 미니 회의실';

  document.getElementById('timeSection').style.display = 'none';
  document.getElementById('formDivider').style.display = 'none';
  document.getElementById('formSection').style.display = 'none';

  document.getElementById('inputTeam').value = '';
  document.getElementById('inputName').value = '';
  document.getElementById('inputPassword').value = '';

  updateConfirmButton();
  renderCalendar();
  showScreen('screenReserve');
}

// ═══════════════════════════════════════════════════════
// 달력 렌더링
// ═══════════════════════════════════════════════════════
function renderCalendar() {
  const year = state.calendarYear;
  const month = state.calendarMonth;
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월',
    '7월', '8월', '9월', '10월', '11월', '12월'];

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const daysInPrevMonth = new Date(year, month, 0).getDate();

  let html = '<div class="calendar-nav">';
  html += '<button onclick="changeMonth(-1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>';
  html += '<span class="calendar-month">' + year + '년 ' + monthNames[month] + '</span>';
  html += '<button onclick="changeMonth(1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>';
  html += '</div>';

  html += '<div class="calendar-weekdays">';
  ['일', '월', '화', '수', '목', '금', '토'].forEach(function(d) {
    html += '<span>' + d + '</span>';
  });
  html += '</div>';

  html += '<div class="calendar-days">';

  // 이전 달
  for (let i = firstDay - 1; i >= 0; i--) {
    html += '<button class="calendar-day disabled other-month">' + (daysInPrevMonth - i) + '</button>';
  }

  // 현재 달
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const dateStr = formatDate(date);
    let classes = 'calendar-day';

    if (date < today) {
      classes += ' disabled';
    }

    if (date.getTime() === today.getTime()) {
      classes += ' today';
    }

    if (state.selectedDate === dateStr) {
      classes += ' selected';
    }

    html += '<button class="' + classes + '" onclick="selectDate(\'' + dateStr + '\')">' + d + '</button>';
  }

  // 다음 달
  const totalCells = firstDay + daysInMonth;
  const remainCells = (7 - (totalCells % 7)) % 7;
  for (let i = 1; i <= remainCells; i++) {
    html += '<button class="calendar-day disabled other-month">' + i + '</button>';
  }

  html += '</div>';

  document.getElementById('calendar').innerHTML = html;
}

function changeMonth(dir) {
  state.calendarMonth += dir;
  if (state.calendarMonth > 11) {
    state.calendarMonth = 0;
    state.calendarYear++;
  } else if (state.calendarMonth < 0) {
    state.calendarMonth = 11;
    state.calendarYear--;
  }
  renderCalendar();
}

function formatDate(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return y + '-' + m + '-' + d;
}

function formatDateKr(dateStr) {
  const parts = dateStr.split('-');
  return parseInt(parts[1]) + '월 ' + parseInt(parts[2]) + '일';
}

// Google Sheets에서 Date 객체 또는 다양한 형식으로 반환될 수 있으므로 정규화
function normalizeDate(val) {
  if (!val) return '';
  // 이미 YYYY-MM-DD 형식이면 그대로 반환
  if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
    return val;
  }
  // ISO 문자열 (2026-02-12T00:00:00.000Z) 또는 Date 호환 문자열
  try {
    var d = new Date(val);
    if (!isNaN(d.getTime())) {
      return d.getFullYear() + '-' +
        String(d.getMonth() + 1).padStart(2, '0') + '-' +
        String(d.getDate()).padStart(2, '0');
    }
  } catch (e) {}
  return String(val);
}

function normalizeTime(val) {
  if (!val) return '';
  // 이미 HH:MM 형식이면 그대로 반환
  if (typeof val === 'string' && /^\d{2}:\d{2}$/.test(val)) {
    return val;
  }
  // Date 객체 또는 ISO 문자열에서 시간 추출
  try {
    // "Sat Dec 30 1899 09:00:00 GMT+0900" 같은 Google Sheets 시간 형식
    var d = new Date(val);
    if (!isNaN(d.getTime())) {
      return String(d.getHours()).padStart(2, '0') + ':' +
        String(d.getMinutes()).padStart(2, '0');
    }
  } catch (e) {}
  return String(val);
}

// ═══════════════════════════════════════════════════════
// 날짜 선택
// ═══════════════════════════════════════════════════════
function selectDate(dateStr) {
  state.selectedDate = dateStr;
  state.selectedStartTime = null;
  state.selectedEndTime = null;
  renderCalendar();
  loadTimeSlots();
}

// ═══════════════════════════════════════════════════════
// 시간 슬롯
// ═══════════════════════════════════════════════════════
async function loadTimeSlots() {
  const section = document.getElementById('timeSection');
  section.style.display = 'block';
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });

  document.getElementById('formDivider').style.display = 'none';
  document.getElementById('formSection').style.display = 'none';
  document.getElementById('timeHint').textContent = '시작 시간을 선택하세요';

  let reservedSlots = [];

  try {
    const res = await apiGet('getReservations', {
      date: state.selectedDate,
      floor: state.selectedFloor
    });
    if (res.success) {
      reservedSlots = (res.data || []).map(function(r) {
        r['시작시간'] = normalizeTime(r['시작시간']);
        r['종료시간'] = normalizeTime(r['종료시간']);
        return r;
      });
    }
  } catch (e) {
    // 오프라인 모드: 예약 현황 없이 표시
  }

  renderTimeGrid(reservedSlots);
  updateConfirmButton();
}

function renderTimeGrid(reservedSlots) {
  const grid = document.getElementById('timeGrid');
  let html = '';

  for (let h = 0; h < 24; h++) {
    for (let m = 0; m < 60; m += 30) {
      const time = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
      const displayTime = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
      let classes = 'time-slot';

      // 예약된 시간 확인
      const isReserved = reservedSlots.some(function(r) {
        return time >= r['시작시간'] && time < r['종료시간'];
      });

      if (isReserved) {
        classes += ' reserved';
      }

      // 선택 상태
      if (state.selectedStartTime && state.selectedEndTime) {
        if (time === state.selectedStartTime || time === addMinutes(state.selectedEndTime, -30)) {
          classes += ' selected';
        } else if (time > state.selectedStartTime && time < state.selectedEndTime) {
          classes += ' in-range';
        }
      } else if (state.selectedStartTime === time) {
        classes += ' selected';
      }

      html += '<button class="' + classes + '" data-time="' + time + '" onclick="selectTime(\'' + time + '\')">' + displayTime + '</button>';
    }
  }

  grid.innerHTML = html;
}

function addMinutes(timeStr, minutes) {
  const parts = timeStr.split(':');
  const h = parseInt(parts[0]);
  const m = parseInt(parts[1]) + minutes;
  const totalMin = h * 60 + m;
  const newH = Math.floor(totalMin / 60);
  const newM = totalMin % 60;
  return String(newH).padStart(2, '0') + ':' + String(newM).padStart(2, '0');
}

function selectTime(time) {
  const hint = document.getElementById('timeHint');

  if (!state.selectedStartTime) {
    // 첫 번째 클릭: 시작 시간 선택
    state.selectedStartTime = time;
    state.selectedEndTime = null;
    hint.textContent = '종료 시간을 선택하세요 (시작: ' + time + ')';
  } else if (!state.selectedEndTime) {
    // 두 번째 클릭: 종료 시간 선택
    if (time <= state.selectedStartTime) {
      // 시작시간보다 같거나 이전이면 리셋
      state.selectedStartTime = time;
      state.selectedEndTime = null;
      hint.textContent = '종료 시간을 선택하세요 (시작: ' + time + ')';
    } else {
      state.selectedEndTime = addMinutes(time, 30);
      hint.textContent = state.selectedStartTime + ' ~ ' + state.selectedEndTime;
      showFormSection();
    }
  } else {
    // 이미 둘 다 선택됨 → 리셋
    state.selectedStartTime = time;
    state.selectedEndTime = null;
    hint.textContent = '종료 시간을 선택하세요 (시작: ' + time + ')';
    document.getElementById('formDivider').style.display = 'none';
    document.getElementById('formSection').style.display = 'none';
  }

  // 그리드 다시 렌더링
  const reservedBtns = [];
  document.querySelectorAll('.time-slot.reserved').forEach(function(btn) {
    reservedBtns.push(btn.dataset.time);
  });

  document.querySelectorAll('.time-slot').forEach(function(btn) {
    const t = btn.dataset.time;
    btn.classList.remove('selected', 'in-range');

    if (state.selectedStartTime && state.selectedEndTime) {
      if (t === state.selectedStartTime || t === addMinutes(state.selectedEndTime, -30)) {
        btn.classList.add('selected');
      } else if (t > state.selectedStartTime && t < state.selectedEndTime) {
        btn.classList.add('in-range');
      }
    } else if (state.selectedStartTime === t) {
      btn.classList.add('selected');
    }
  });

  updateConfirmButton();
}

function showFormSection() {
  document.getElementById('formDivider').style.display = 'block';
  const section = document.getElementById('formSection');
  section.style.display = 'block';

  // 선택 요약 표시
  const summary = document.getElementById('selectionSummary');
  summary.innerHTML =
    '<div class="sel-item"><span class="sel-label">층</span><span class="sel-value">' + state.selectedFloor + '</span></div>' +
    '<div class="sel-item"><span class="sel-label">날짜</span><span class="sel-value">' + formatDateKr(state.selectedDate) + '</span></div>' +
    '<div class="sel-item"><span class="sel-label">시간</span><span class="sel-value">' + state.selectedStartTime + ' ~ ' + state.selectedEndTime + '</span></div>';

  setTimeout(function() {
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

// ═══════════════════════════════════════════════════════
// 예약 제출
// ═══════════════════════════════════════════════════════
function updateConfirmButton() {
  const btn = document.getElementById('btnConfirmReserve');
  const team = document.getElementById('inputTeam').value.trim();
  const name = document.getElementById('inputName').value.trim();
  const pw = document.getElementById('inputPassword').value.trim();

  const isValid = state.selectedDate &&
    state.selectedStartTime &&
    state.selectedEndTime &&
    team.length > 0 &&
    name.length > 0 &&
    /^\d{4}$/.test(pw);

  btn.disabled = !isValid;
  btn.textContent = isValid ? '예약 완료' : '모든 정보를 입력해주세요';
}

// 입력 필드 이벤트 리스너
document.addEventListener('input', function(e) {
  if (['inputTeam', 'inputName', 'inputPassword'].includes(e.target.id)) {
    updateConfirmButton();
  }
});

async function submitReservation() {
  const btn = document.getElementById('btnConfirmReserve');
  if (btn.disabled) return;

  showLoading(true);

  try {
    const res = await apiPost({
      action: 'createReservation',
      date: state.selectedDate,
      floor: state.selectedFloor,
      startTime: state.selectedStartTime,
      endTime: state.selectedEndTime,
      teamName: document.getElementById('inputTeam').value.trim(),
      userName: document.getElementById('inputName').value.trim(),
      password: document.getElementById('inputPassword').value.trim()
    });

    showLoading(false);

    if (res.success) {
      showCompleteScreen(res.data);
      showToast('예약이 완료되었습니다!', 'success');
    } else {
      showToast(res.error || '예약에 실패했습니다.', 'error');
    }
  } catch (e) {
    showLoading(false);
    showToast('서버 연결에 실패했습니다.', 'error');
  }
}

function showCompleteScreen(data) {
  const card = document.getElementById('completeCard');
  card.innerHTML =
    '<div class="card-header">' +
      '<span class="card-floor">' + data['층'] + '</span>' +
      '<span class="card-time">' + data['시작시간'] + ' ~ ' + data['종료시간'] + '</span>' +
    '</div>' +
    '<div class="card-info">' +
      '<div class="card-row"><span class="label">날짜</span><span class="value">' + formatDateKr(data['날짜']) + '</span></div>' +
      '<div class="card-row"><span class="label">팀명</span><span class="value">' + data['팀명'] + '</span></div>' +
      '<div class="card-row"><span class="label">예약자</span><span class="value">' + data['예약자'] + '</span></div>' +
    '</div>';

  showScreen('screenComplete');
}

// ═══════════════════════════════════════════════════════
// 예약 내역 조회
// ═══════════════════════════════════════════════════════
async function loadReservations() {
  const list = document.getElementById('reservationsList');
  list.innerHTML = '<div style="text-align:center; padding:40px 0;"><div class="spinner" style="margin:0 auto;"></div></div>';

  try {
    const res = await apiGet('getReservations', {});

    if (res.success) {
      // 날짜/시간 데이터 정규화 (Google Sheets가 Date 객체로 반환할 수 있음)
      state.reservations = (res.data || []).map(function(r) {
        r['날짜'] = normalizeDate(r['날짜']);
        r['시작시간'] = normalizeTime(r['시작시간']);
        r['종료시간'] = normalizeTime(r['종료시간']);
        return r;
      }).sort(function(a, b) {
        if (a['날짜'] !== b['날짜']) return a['날짜'] > b['날짜'] ? 1 : -1;
        return a['시작시간'] > b['시작시간'] ? 1 : -1;
      });
      renderReservations();
    } else {
      list.innerHTML = '<div class="empty-state"><p>데이터를 불러올 수 없습니다.</p></div>';
    }
  } catch (e) {
    list.innerHTML = '<div class="empty-state"><p>서버에 연결할 수 없습니다.</p></div>';
  }
}

function renderReservations() {
  const list = document.getElementById('reservationsList');
  let filtered = state.reservations;

  if (state.currentTab !== 'all') {
    filtered = filtered.filter(function(r) {
      return r['층'] === state.currentTab;
    });
  }

  // 오늘 이후만 표시
  const today = formatDate(new Date());
  filtered = filtered.filter(function(r) {
    return r['날짜'] >= today;
  });

  if (filtered.length === 0) {
    list.innerHTML =
      '<div class="empty-state">' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' +
        '<p>예약된 회의실이 없습니다</p>' +
      '</div>';
    return;
  }

  // 날짜별 그룹핑
  const grouped = {};
  filtered.forEach(function(r) {
    if (!grouped[r['날짜']]) grouped[r['날짜']] = [];
    grouped[r['날짜']].push(r);
  });

  let html = '';
  Object.keys(grouped).sort().forEach(function(date) {
    html += '<div class="date-badge">' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' +
      formatDateKr(date) +
    '</div>';

    grouped[date].forEach(function(r) {
      html +=
        '<div class="reservation-card fade-in">' +
          '<div class="card-header">' +
            '<span class="card-floor">' + r['층'] + '</span>' +
            '<span class="card-time">' + r['시작시간'] + ' ~ ' + r['종료시간'] + '</span>' +
          '</div>' +
          '<div class="card-info">' +
            '<div class="card-row"><span class="label">팀명</span><span class="value">' + r['팀명'] + '</span></div>' +
            '<div class="card-row"><span class="label">예약자</span><span class="value">' + r['예약자'] + '</span></div>' +
          '</div>' +
          '<div class="card-actions">' +
            '<button class="btn btn-outline" style="flex:1" onclick="requestEdit(\'' + r['예약ID'] + '\')">수정</button>' +
            '<button class="btn btn-outline-red" style="flex:1" onclick="requestDelete(\'' + r['예약ID'] + '\')">삭제</button>' +
          '</div>' +
        '</div>';
    });
  });

  list.innerHTML = html;
}

function switchTab(el) {
  document.querySelectorAll('.tab-item').forEach(function(t) {
    t.classList.remove('active');
  });
  el.classList.add('active');
  state.currentTab = el.dataset.tab;
  renderReservations();
}

// ═══════════════════════════════════════════════════════
// 수정 / 삭제
// ═══════════════════════════════════════════════════════
function requestEdit(id) {
  state.pendingAction = 'edit';
  state.pendingId = id;
  document.getElementById('modalPasswordInput').value = '';
  openModal('modalPassword');

  document.getElementById('modalPasswordConfirm').onclick = function() {
    verifyAndEdit(id);
  };
}

function requestDelete(id) {
  state.pendingAction = 'delete';
  state.pendingId = id;
  document.getElementById('modalPasswordInput').value = '';
  openModal('modalPassword');

  document.getElementById('modalPasswordConfirm').onclick = function() {
    verifyAndDelete(id);
  };
}

async function verifyAndEdit(id) {
  const pw = document.getElementById('modalPasswordInput').value.trim();
  if (!pw) {
    showToast('비밀번호를 입력하세요.', 'error');
    return;
  }

  showLoading(true);
  closeModal('modalPassword');

  try {
    const res = await apiPost({
      action: 'verifyPassword',
      id: id,
      password: pw
    });

    showLoading(false);

    if (res.success) {
      // 해당 예약 정보로 예약 화면 열기
      const reservation = state.reservations.find(function(r) {
        return r['예약ID'] === id;
      });

      if (reservation) {
        state.selectedFloor = reservation['층'];
        state.selectedDate = reservation['날짜'];
        state.selectedStartTime = reservation['시작시간'];
        state.selectedEndTime = reservation['종료시간'];

        document.getElementById('reserveTitle').textContent = '예약 수정';
        document.getElementById('reserveSubtitle').textContent = 'J동 ' + reservation['층'] + ' 미니 회의실';
        document.getElementById('inputTeam').value = reservation['팀명'];
        document.getElementById('inputName').value = reservation['예약자'];
        document.getElementById('inputPassword').value = pw;

        renderCalendar();
        await loadTimeSlots();
        showFormSection();
        updateConfirmButton();
        showScreen('screenReserve');

        // 제출 버튼을 수정 모드로 변경
        const btn = document.getElementById('btnConfirmReserve');
        btn.textContent = '예약 수정';
        btn.onclick = function() { submitUpdate(id, pw); };
      }
    } else {
      showToast(res.error || '인증에 실패했습니다.', 'error');
    }
  } catch (e) {
    showLoading(false);
    showToast('서버 연결에 실패했습니다.', 'error');
  }
}

async function submitUpdate(id, pw) {
  showLoading(true);

  try {
    const res = await apiPost({
      action: 'updateReservation',
      id: id,
      password: pw,
      date: state.selectedDate,
      floor: state.selectedFloor,
      startTime: state.selectedStartTime,
      endTime: state.selectedEndTime,
      teamName: document.getElementById('inputTeam').value.trim(),
      userName: document.getElementById('inputName').value.trim()
    });

    showLoading(false);

    if (res.success) {
      showToast('예약이 수정되었습니다.', 'success');
      // 제출 버튼 원래대로
      const btn = document.getElementById('btnConfirmReserve');
      btn.onclick = function() { submitReservation(); };
      navigateTo('screenMyReservations');
    } else {
      showToast(res.error || '수정에 실패했습니다.', 'error');
    }
  } catch (e) {
    showLoading(false);
    showToast('서버 연결에 실패했습니다.', 'error');
  }
}

async function verifyAndDelete(id) {
  const pw = document.getElementById('modalPasswordInput').value.trim();
  if (!pw) {
    showToast('비밀번호를 입력하세요.', 'error');
    return;
  }

  closeModal('modalPassword');

  // 삭제 확인 모달
  openModal('modalDelete');
  document.getElementById('modalDeleteConfirm').onclick = async function() {
    closeModal('modalDelete');
    showLoading(true);

    try {
      const res = await apiPost({
        action: 'deleteReservation',
        id: id,
        password: pw
      });

      showLoading(false);

      if (res.success) {
        showToast('예약이 삭제되었습니다.', 'success');
        loadReservations();
      } else {
        showToast(res.error || '삭제에 실패했습니다.', 'error');
      }
    } catch (e) {
      showLoading(false);
      showToast('서버 연결에 실패했습니다.', 'error');
    }
  };
}

// ═══════════════════════════════════════════════════════
// 모달
// ═══════════════════════════════════════════════════════
function openModal(id) {
  const overlay = document.getElementById(id);
  overlay.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeModal(id) {
  const overlay = document.getElementById(id);
  overlay.classList.remove('show');
  document.body.style.overflow = '';
}

// 모달 바깥 클릭 시 닫기
document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) {
      overlay.classList.remove('show');
      document.body.style.overflow = '';
    }
  });
});

// ═══════════════════════════════════════════════════════
// 토스트 메시지
// ═══════════════════════════════════════════════════════
function showToast(message, type) {
  type = type || '';
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast ' + type;
  toast.textContent = message;
  container.appendChild(toast);

  requestAnimationFrame(function() {
    toast.classList.add('show');
  });

  setTimeout(function() {
    toast.classList.remove('show');
    setTimeout(function() {
      container.removeChild(toast);
    }, 300);
  }, 2500);
}

// ═══════════════════════════════════════════════════════
// 로딩
// ═══════════════════════════════════════════════════════
function showLoading(show) {
  const overlay = document.getElementById('loadingOverlay');
  if (show) {
    overlay.classList.add('show');
  } else {
    overlay.classList.remove('show');
  }
}

// ═══════════════════════════════════════════════════════
// API 통신
// ═══════════════════════════════════════════════════════
async function apiGet(action, params) {
  let url = API_URL + '?action=' + encodeURIComponent(action);
  Object.keys(params).forEach(function(key) {
    if (params[key]) {
      url += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
    }
  });

  const response = await fetch(url, { redirect: 'follow' });
  return await response.json();
}

async function apiPost(body) {
  const response = await fetch(API_URL, {
    method: 'POST',
    redirect: 'follow',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(body)
  });
  return await response.json();
}

// ═══════════════════════════════════════════════════════
// SHA-256 (클라이언트 사이드, 표시용 - 실제 해싱은 서버에서)
// ═══════════════════════════════════════════════════════
async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
}
</script>

</body>
</html>
